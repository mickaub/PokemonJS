<!DOCTYPE html>
<!--
Basics of Pokemon game
walking grid creation, Start state/button, audio states, movement state, triggering encounters, fadein state, battlestate,
battlemenu state, taketurn state,
victory/defeat conditions, fadein/out state, final battle/win conditions.

CS50 sections
Start State, FadeIn state, dialogue state, playState, gird aligned movment, dialogue revisited,level,
triggering encounters, Panel/Textbox, Selection, Menu, Party and Pokemon, battlesprite, shaders,
battlestate, battlemenu state, taketurn state

Left: fadein state,
taketurn state
fadein/out state

Win condition: Fight trainer and win.

-->
<html lang="en">
<head>
<title>PokemonJS</title>
<meta charset="UFT-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
</head>
<style>
@keyframes fading{
    0%{opacity: 0%;}
    50%{opacity: 100%;}
    100%{opacity: 0%;}
}
.square{
    height: 256px;
    width: 256px;
   /* background-color: green;*/
}
.fader{
    background-color:black;
    opacity: 0%;
}
.fader.change{
   animation: fading 3s 1;
}
.terrain{
    background-color: green;
}
.combat{
    background-color: antiquewhite;
}
#M-Layer {
    width: 256px;
    height: 256px;
    z-index: 1;
    position:absolute;
    display: flex;
    flex-wrap: wrap;
}
#T-Layer {
    width: 256px;
    height: 256px;
    z-index: 5;
    position:absolute;
    /*margin-top: -100px;*/
}
#B-Layer {
    width: 256px;
    height: 256px;
    position:absolute;
    z-index: 3;
    opacity: 0%;
    /*margin-top: -50px;*/
}
#screen-container {
    height: 256px;
    width: 256px;
    display: flex;
    flex-wrap: wrap;
}
.tile{
    height: 32px;
    width: 32px;
   /* background-color: white;*/
}
</style>
<body>
<h2>PokemonJS Game</h2>
<div id="grid1"></div>
<br>
<audio id="audioB" src="battleV3.mp3" loop="true"></audio>
<audio id="audioW" src="walkingV3.mp3" loop="true"></audio>
<button id="playButton" onclick="Play(1,2)";>Play B</button>
<button id="playButton" onclick="Play(2,2)";>Stop B</button>
<button id="playButton" onclick="Play(1,1)";>Play W</button>
<button id="playButton" onclick="Play(2,1)";>Stop W</button>
<div id="startButton"></div>
<button id="leftDir" onclick="Move(-1)">Move L</button>
<button id="downDir" onclick="Move(-8)">Move D</button>
<button id="upDir" onclick="Move(8)">Move U</button>
<button id="rightDir" onclick="Move(1)">Move R</button>
<button id="resetButton" onclick="Reset()">Reset</button>
<br>
<button id="fightTrainer" onclick="FightTrainer()">Fight Trainer</button>
<br>
<div id="battleScreen">
    <div id="enemyHealth">&nbsp;</div>
    <div id="playerHealth">&nbsp;</div>
    <br>    
    <button id="Fight" onclick="BattleAction(0)">Fight</button><!--tempFunction-->
    <button id="Heal" onclick="BattleAction(1)">Heal</button><!--tempFunction-->
    <div id="experience">EXP: 0</div>
    <div id="level">LEVEL: 1</div>
</div>
<div id="text-box"></div>
<div id="screen-container">
    <div id="M-Layer" class="square terrain"></div>
    <div id="B-Layer" class="square combat"></div>
    <div id="T-Layer" class="square fader"></div>
</div>
<button id="tester" onclick="Test()">Tester</button>
<!--<audio controls> 
<source src="battleV3.mp3" type="audio/mp3">
Audio not supported.
</audio>-->
</body>
<script>
let gridL1 = [1,1,1,1,1,1,1,1];
let gridL2 = [1,0,0,0,0,0,0,1];
let gridL3 = [1,0,0,0,0,0,0,1]
let gridL4 = [1,0,0,0,0,0,0,1]
let gridL5 = [1,0,0,0,0,0,0,1]
let gridL6 = [1,0,0,0,0,0,0,1]
let gridL7 = [1,0,0,0,0,0,0,1]
let gridL8 = [1,1,1,1,1,1,1,1];
let gridSum = gridL1.concat(gridL2,gridL3,gridL4,gridL5,gridL6,gridL7,gridL8);
let startState = false;
let movementState = false;
let battleState = false;
let playerPos = [1,1]; //up/down then left/right
let trainerPos = [4,6];
let nearTrainer = false;
let encounterSteps = -1;
let enemyHealth = 5;
let fullHealth = 10;
let playerHealth = 10;
let experience = 0;
let level = 1;
let playerAttack = 3;
let enemyAttack = 3;
let enemyTurn = false;
let fightTrainer = false;
console.log(gridSum.length,gridSum[11]);

gridL2[1] = 2; //player init
gridL5[6] = 3;

let mapTiles = document.getElementById("M-Layer");
for(let i=0;i<64;i++){
    let tile = document.createElement('div');
    tile.classList.add("tile");
    tile.id = "T"  + i;
    if(gridSum[i]==1){
        tile.style.backgroundColor = "green";
    }
    else{
        tile.style.backgroundColor = "brown";
    }
    tile.style.backgroundColor
    mapTiles.append(tile);
}
document.getElementById("T9").style.backgroundColor = "black";
let playerID = 9;
document.getElementById("T38").style.backgroundColor = "black";

encounterSteps = Math.floor(Math.random()*5) + 1;
console.log(encounterSteps);

document.getElementById("grid1").innerHTML = gridL1 + "<br>" + gridL2 + "<br>"+ gridL3 + "<br>"+ gridL4 + "<br>"+ gridL5 + "<br>"+ gridL6 + "<br>"+ gridL7 + "<br>"+ gridL8;
document.getElementById("startButton").innerHTML = "<button onclick=\"Start()\">Start</button>";

function Test(){
    document.getElementById("T-Layer").animate( //web animations API
        [ //keyframe properties
            {opacity: "0%"},
            {opacity: "100%"},
            {opacity: "0%"},
        ],
        { //timing properties
            duration: 3000,
            iterations: 1,
        },
    );
}

function Play(state,source){    
    let audio;
    if(source==1){
        audio = document.getElementById("audioW");
    }
    if(source==2){
        audio = document.getElementById("audioB");
    }    
    if(state==1){
        audio.play();
    }
    if(state==2){
        audio.pause();
        audio.currentTime = 0;
    }
}
function Start(){
    document.getElementById("startButton").innerHTML = "";
    startState = true;
    console.log("StartState: ",startState);
    Play(1,1)
    movementState = true;
}
movementState = true;//temp

function Move(direction){    

    if(movementState==false){
        return;
    }
    let ud = playerPos[0];
    let lr = playerPos[1];

    nearTrainer = false;
    console.log(nearTrainer);//temp

    if(direction==-8){
        if(ud==6){
            return;
        }
        if(ud==3&&lr==6){
            nearTrainer = true;
            console.log(nearTrainer);//temp
            return;
        }
        if(ud==1){
            gridL2[lr]=0;
            gridL3[lr]=2;   
        }
        if(ud==2){
            gridL3[lr]=0;
            gridL4[lr]=2;         
        }
        if(ud==3){
            gridL4[lr]=0;
            gridL5[lr]=2;         
        }
        if(ud==4){
            gridL5[lr]=0;
            gridL6[lr]=2;                  
        }
        if(ud==5){
            gridL6[lr]=0;
            gridL7[lr]=2;               
        }           
        playerPos[0] += 1;
        document.getElementById(`T${playerID}`).style.backgroundColor = "brown";
        playerID += 8;
        document.getElementById(`T${playerID}`).style.backgroundColor = "black";
    }
    if(direction==8){
        if(ud==1){
            return;
        }    
        if(ud==5&&lr==6){
            nearTrainer = true;
            console.log(nearTrainer);//temp
            return;
        }   
        if(ud==2){
            gridL2[lr]=2;
            gridL3[lr]=0;         
        }
        if(ud==3){
            gridL3[lr]=2;
            gridL4[lr]=0;         
        }
        if(ud==4){
            gridL4[lr]=2;
            gridL5[lr]=0;         
        }
        if(ud==5){
            gridL5[lr]=2;
            gridL6[lr]=0;                  
        }         
        if(ud==6){
            gridL6[lr]=2;
            gridL7[lr]=0;               
        }          
        playerPos[0] -= 1;
        document.getElementById(`T${playerID}`).style.backgroundColor = "brown";
        playerID -= 8;
        document.getElementById(`T${playerID}`).style.backgroundColor = "black";
    }
    if(direction==1){
        let newlr = lr + 1;
        if(lr==6){
            return;
        }  
        if(ud==4&&lr==5){
            nearTrainer = true;
            console.log(nearTrainer);//temp
            return;
        }
        if(ud==1){
            gridL2[lr]=0;
            gridL2[newlr]=2;         
        }   
        if(ud==2){
            gridL3[lr]=0;
            gridL3[newlr]=2;         
        }    
        if(ud==3){
            gridL4[lr]=0;
            gridL4[newlr]=2;         
        }    
        if(ud==4){
            gridL5[lr]=0;
            gridL5[newlr]=2;         
        }    
        if(ud==5){
            gridL6[lr]=0;
            gridL6[newlr]=2;         
        }    
        if(ud==6){
            gridL7[lr]=0;
            gridL7[newlr]=2;         
        }              
        playerPos[1] += 1;
        document.getElementById(`T${playerID}`).style.backgroundColor = "brown";
        playerID += 1;
        document.getElementById(`T${playerID}`).style.backgroundColor = "black";
    }
    if(direction==-1){
        let newlr = lr - 1;
        if(lr==1){
            return;
        }  
        if(ud==1){
            gridL2[lr]=0;
            gridL2[newlr]=2;         
        }   
        if(ud==2){
            gridL3[lr]=0;
            gridL3[newlr]=2;         
        }    
        if(ud==3){
            gridL4[lr]=0;
            gridL4[newlr]=2;         
        }    
        if(ud==4){
            gridL5[lr]=0;
            gridL5[newlr]=2;         
        }    
        if(ud==5){
            gridL6[lr]=0;
            gridL6[newlr]=2;         
        }    
        if(ud==6){
            gridL7[lr]=0;
            gridL7[newlr]=2;         
        }              
        playerPos[1] -= 1;
        document.getElementById(`T${playerID}`).style.backgroundColor = "brown";
        playerID -= 1;
        document.getElementById(`T${playerID}`).style.backgroundColor = "black";
    }
    document.getElementById("grid1").innerHTML = gridL1 + "<br>" + gridL2 + "<br>"+ gridL3 + "<br>"+ gridL4 + "<br>"+ gridL5 + "<br>"+ gridL6 + "<br>"+ gridL7 + "<br>"+ gridL8;
    console.log(playerPos);

    if(playerPos[0]==3||playerPos[0]==5){
        if(playerPos[1]==6){
            console.log("close");
            nearTrainer = true;
            console.log(nearTrainer);//temp
        }
    }
    if(playerPos[0]==4&&playerPos[1]==5){
        console.log("close");
        nearTrainer = true;
        console.log(nearTrainer);//temp
    }

    encounterSteps -= 1;
    if(encounterSteps==0){
        movementState = false;
        battleState = true;
        BattleStart(0);
    }
}
/*
battle order:
battleStart
battleAction (turns of both players)
battleEnd
*/
function BattleStart(Trainer){
    enemyHealth = 5;
    if(Trainer==1){
        enemyHealth = 15;
        enemyAttack = 8;
    }
    document.getElementById("enemyHealth").innerHTML = "Enemy: " + enemyHealth + "HP";
    document.getElementById("playerHealth").innerHTML = "Player: " + playerHealth + "HP";
}

function BattleAction(Action){
    if(Action==0){//fight
        enemyHealth -= playerAttack;
        document.getElementById("enemyHealth").innerHTML = "Enemy: " + enemyHealth + "HP";
            
    }
    if(Action==1){//heal   
        playerHealth += 8;
        if(playerHealth>fullHealth){
            playerHealth = fullHealth;
        }        
        document.getElementById("playerHealth").innerHTML = "Player: " + playerHealth + "HP";
    }
    if(enemyHealth <= 0){
        document.getElementById("enemyHealth").innerHTML = "Enemy: " + "0" + "HP";
        setTimeout(
            function(){
                BattleEnd(1);
                return;
            }
        ,1000);            
    }    
    else{ 
        setTimeout(//set enemy turn and wait
            function(){
                playerHealth -= enemyAttack
                if(playerHealth<=0){
                    BattleEnd(0);
                }
                else{
                    document.getElementById("playerHealth").innerHTML = "Player: " + playerHealth + "HP";
                }
            }        
        ,1000);
    }
}

function BattleEnd(Action){
    if(Action==0){ //loss
        document.getElementById("playerHealth").innerHTML = "Player: " + "0" + "HP";
        document.getElementById("text-box").innerHTML = "Defeat...";
        if(fightTrainer==true){
            fightTrainer=false;
        }
        setTimeout(
            function(){
                playerHealth = fullHealth;
                document.getElementById("enemyHealth").innerHTML = "&nbsp";
                document.getElementById("playerHealth").innerHTML = "&nbsp";
                document.getElementById("text-box").innerHTML = "&nbsp";
                gridL2 = [1,0,0,0,0,0,0,1];
                gridL3 = [1,0,0,0,0,0,0,1];
                gridL4 = [1,0,0,0,0,0,0,1];
                gridL5 = [1,0,0,0,0,0,0,1];
                gridL6 = [1,0,0,0,0,0,0,1];
                gridL7 = [1,0,0,0,0,0,0,1];
                gridL2[1] = 2;
                gridL5[6] = 3;
                document.getElementById("grid1").innerHTML = gridL1 + "<br>" + gridL2 + "<br>"+ gridL3 + "<br>"+ gridL4 + "<br>"+ gridL5 + "<br>"+ gridL6 + "<br>"+ gridL7 + "<br>"+ gridL8;
                playerPos = [1,1];
                document.getElementById(`T${playerID}`).style.backgroundColor = "brown";
                playerID = 9;
                document.getElementById(`T${playerID}`).style.backgroundColor = "black";
                movementState = true;
            }
        ,1000)        
    }
    if(Action==1){//win
        experience += 50;        
        document.getElementById("text-box").innerHTML = "Victory!";
        if(fightTrainer == true){
            document.getElementById("text-box").innerHTML = "TRAINER DEFEATED!";
        }
        if(experience==100){
            LevelUp();
        }
        else{
            document.getElementById("experience").innerHTML = "EXP: " + experience;
        }
        setTimeout(
            function(){
                document.getElementById("enemyHealth").innerHTML = "&nbsp";
                document.getElementById("playerHealth").innerHTML = "&nbsp";
                if(fightTrainer==false){
                    document.getElementById("text-box").innerHTML = "&nbsp";
                };               
            }            
        ,1000);
    }
    if(fightTrainer==false){
        movementState = true;
        battleState = false;
        encounterSteps = Math.floor(Math.random()*5) + 1;
        console.log(encounterSteps);
        enemyHealth = 5;
        enemyAttack = 3;
    }   
}

function LevelUp(){
    level += 1;
    experience -= 100;
    playerAttack += 3;
    fullHealth += 3;
    playerHealth = fullHealth;

    document.getElementById("level").innerHTML = "LEVEL: " + level;
    document.getElementById("experience").innerHTML = "EXP: " + experience;
    document.getElementById("playerHealth").innerHTML = "Player: " + playerHealth + "HP";
    document.getElementById("text-box").innerHTML += "Level UP!";
    setTimeout(
        function(){
            document.getElementById("text-box").innerHTML = "&nbsp";
        }
    ,1000)
}

function FightTrainer(){
    if(nearTrainer==true){
        console.log("fighting");       
        BattleStart(1);
        fightTrainer = true;
        document.getElementById("text-box").innerHTML = "Fight Me!";
        movementState = false;
        setTimeout(
            function(){
                document.getElementById("text-box").innerHTML = "&nbsp";
            }
        ,1000)
    }
}
function Reset(){
    location.reload();
}
</script>
</html>